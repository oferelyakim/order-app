<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Place Order</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      text-align: center;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: #333;
      font-size: 1.5rem;
      margin-bottom: 5px;
    }
    
    .header .customer-name {
      color: #666;
      font-size: 0.9rem;
    }
    
    /* Error/Loading States */
    .error-screen, .loading-screen {
      text-align: center;
      padding: 60px 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .error-screen {
      color: #d32f2f;
    }
    
    .error-screen h2 {
      margin-bottom: 10px;
    }
    
    .loading-screen {
      color: #666;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e0e0e0;
      border-top-color: #1976d2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Product Grid */
    .products {
      display: grid;
      gap: 15px;
    }
    
    .product-card {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: #e0e0e0;
      flex-shrink: 0;
    }
    
    .product-info {
      flex: 1;
      min-width: 0;
    }
    
    .product-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .product-price {
      color: #1976d2;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .qty-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      background: #e3f2fd;
      color: #1976d2;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .qty-btn:hover {
      background: #bbdefb;
    }
    
    .qty-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .qty-value {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    /* Cart Summary */
    .cart-summary {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 15px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    
    .cart-summary.visible {
      display: block;
    }
    
    .cart-inner {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }
    
    .cart-info {
      flex: 1;
    }
    
    .cart-items-count {
      font-size: 0.85rem;
      color: #666;
    }
    
    .cart-total {
      font-size: 1.2rem;
      font-weight: 700;
      color: #333;
    }
    
    .checkout-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    .checkout-btn:hover {
      background: #1565c0;
    }
    
    .checkout-btn:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }
    
    .modal-overlay.visible {
      display: flex;
    }
    
    .modal {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-size: 1.2rem;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .order-items {
      margin-bottom: 20px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-item-name {
      color: #333;
    }
    
    .order-item-qty {
      color: #666;
      font-size: 0.9rem;
    }
    
    .order-item-price {
      font-weight: 500;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
      border-top: 2px solid #e0e0e0;
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .notes-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 20px;
    }
    
    .notes-input:focus {
      outline: none;
      border-color: #1976d2;
    }
    
    .submit-btn {
      width: 100%;
      background: #4caf50;
      color: #fff;
      border: none;
      padding: 16px;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    .submit-btn:hover {
      background: #43a047;
    }
    
    .submit-btn:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
    }
    
    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 40px 20px;
    }
    
    .success-icon {
      width: 80px;
      height: 80px;
      background: #e8f5e9;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 2.5rem;
    }
    
    .success-screen h2 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    
    .success-screen p {
      color: #666;
      margin-bottom: 20px;
    }
    
    .new-order-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    
    /* Spacer for fixed cart */
    .bottom-spacer {
      height: 100px;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Loading State -->
    <div class="loading-screen" id="loadingScreen">
      <div class="spinner"></div>
      <p>Loading products...</p>
    </div>
  </div>

  <!-- Cart Summary (Fixed Bottom) -->
  <div class="cart-summary" id="cartSummary">
    <div class="cart-inner">
      <div class="cart-info">
        <div class="cart-items-count" id="cartItemsCount">0 items</div>
        <div class="cart-total">$<span id="cartTotal">0.00</span></div>
      </div>
      <button class="checkout-btn" id="checkoutBtn">Review Order</button>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal-overlay" id="checkoutModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Review Order</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <script>
    // ====================
    // CONFIGURATION
    // ====================
    const API_URL = 'https://script.google.com/macros/s/AKfycbxwCyGsmHthmb6UjbEJGGiS6PKIKIJpER_Zy2GPwyMjGJvWhL_JxtlEHbD3eFCtwUQssw/exec';
    
    // ====================
    // STATE
    // ====================
    let customer = null;
    let products = [];
    let cart = {}; // { productId: qty }
    
    // ====================
    // INIT
    // ====================
    async function init() {
      const customerId = new URLSearchParams(window.location.search).get('c');
      
      if (!customerId) {
        showError('Invalid Link', 'Please use the order link provided to you.');
        return;
      }
      
      try {
        // Validate customer
        const customerRes = await fetch(`${API_URL}?action=getCustomer&customerId=${encodeURIComponent(customerId)}`);
        const customerData = await customerRes.json();
        
        if (!customerData.success || !customerData.data) {
          showError('Invalid Customer', 'Your order link is not valid. Please contact us for assistance.');
          return;
        }
        
        customer = customerData.data;
        
        // Load products
        const productsRes = await fetch(`${API_URL}?action=getProducts`);
        const productsData = await productsRes.json();
        
        if (!productsData.success) {
          showError('Error', 'Failed to load products. Please try again.');
          return;
        }
        
        products = productsData.data;
        renderApp();
        
      } catch (error) {
        console.error('Init error:', error);
        showError('Connection Error', 'Unable to connect. Please check your internet and try again.');
      }
    }
    
    // ====================
    // RENDER
    // ====================
    function showError(title, message) {
      document.getElementById('app').innerHTML = `
        <div class="error-screen">
          <h2>${title}</h2>
          <p>${message}</p>
        </div>
      `;
    }
    
    function renderApp() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="header">
          <h1>Place Your Order</h1>
          <p class="customer-name">Welcome, ${escapeHtml(customer.customerName)}</p>
        </div>
        <div class="products" id="productsList">
          ${products.map(renderProduct).join('')}
        </div>
        <div class="bottom-spacer"></div>
      `;
      
      // Attach event listeners
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', handleQtyChange);
      });
      
      document.getElementById('checkoutBtn').addEventListener('click', openCheckoutModal);
      document.getElementById('closeModal').addEventListener('click', closeCheckoutModal);
      document.getElementById('checkoutModal').addEventListener('click', (e) => {
        if (e.target.id === 'checkoutModal') closeCheckoutModal();
      });
      
      updateCartSummary();
    }
    
    function renderProduct(product) {
      const qty = cart[product.id] || 0;
      const imgSrc = product.imageUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23e0e0e0" width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="%23999" font-size="14">No Image</text></svg>';
      
      return `
        <div class="product-card" data-id="${product.id}">
          <img class="product-image" src="${escapeHtml(imgSrc)}" alt="${escapeHtml(product.name)}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e0e0e0%22 width=%22100%22 height=%22100%22/></svg>'">
          <div class="product-info">
            <div class="product-name">${escapeHtml(product.name)}</div>
            <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
            <div class="qty-controls">
              <button class="qty-btn" data-action="decrease" data-id="${product.id}" ${qty === 0 ? 'disabled' : ''}>−</button>
              <span class="qty-value" id="qty-${product.id}">${qty}</span>
              <button class="qty-btn" data-action="increase" data-id="${product.id}">+</button>
            </div>
          </div>
        </div>
      `;
    }
    
    // ====================
    // CART LOGIC
    // ====================
    function handleQtyChange(e) {
      const btn = e.target;
      const productId = btn.dataset.id;
      const action = btn.dataset.action;
      
      if (!cart[productId]) cart[productId] = 0;
      
      if (action === 'increase') {
        cart[productId]++;
      } else if (action === 'decrease' && cart[productId] > 0) {
        cart[productId]--;
      }
      
      // Update display
      document.getElementById(`qty-${productId}`).textContent = cart[productId];
      
      // Update decrease button state
      const decreaseBtn = document.querySelector(`.qty-btn[data-action="decrease"][data-id="${productId}"]`);
      decreaseBtn.disabled = cart[productId] === 0;
      
      updateCartSummary();
    }
    
    function updateCartSummary() {
      const items = Object.entries(cart).filter(([_, qty]) => qty > 0);
      const totalItems = items.reduce((sum, [_, qty]) => sum + qty, 0);
      const totalAmount = items.reduce((sum, [id, qty]) => {
        const product = products.find(p => p.id === id);
        return sum + (product ? product.price * qty : 0);
      }, 0);
      
      document.getElementById('cartItemsCount').textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
      document.getElementById('cartTotal').textContent = totalAmount.toFixed(2);
      
      const cartSummary = document.getElementById('cartSummary');
      if (totalItems > 0) {
        cartSummary.classList.add('visible');
      } else {
        cartSummary.classList.remove('visible');
      }
    }
    
    function getCartTotal() {
      return Object.entries(cart)
        .filter(([_, qty]) => qty > 0)
        .reduce((sum, [id, qty]) => {
          const product = products.find(p => p.id === id);
          return sum + (product ? product.price * qty : 0);
        }, 0);
    }
    
    // ====================
    // CHECKOUT
    // ====================
    function openCheckoutModal() {
      const items = Object.entries(cart)
        .filter(([_, qty]) => qty > 0)
        .map(([id, qty]) => {
          const product = products.find(p => p.id === id);
          return { ...product, qty };
        });
      
      const total = getCartTotal();
      
      document.getElementById('modalBody').innerHTML = `
        <div class="order-items">
          ${items.map(item => `
            <div class="order-item">
              <div>
                <div class="order-item-name">${escapeHtml(item.name)}</div>
                <div class="order-item-qty">x${item.qty}</div>
              </div>
              <div class="order-item-price">$${(item.price * item.qty).toFixed(2)}</div>
            </div>
          `).join('')}
        </div>
        <div class="order-total">
          <span>Total</span>
          <span>$${total.toFixed(2)}</span>
        </div>
        <textarea class="notes-input" id="orderNotes" placeholder="Add notes (optional)"></textarea>
        <button class="submit-btn" id="submitOrder">Submit Order</button>
      `;
      
      document.getElementById('submitOrder').addEventListener('click', submitOrder);
      document.getElementById('checkoutModal').classList.add('visible');
    }
    
    function closeCheckoutModal() {
      document.getElementById('checkoutModal').classList.remove('visible');
    }
    
    async function submitOrder() {
      const submitBtn = document.getElementById('submitOrder');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      const items = Object.entries(cart)
        .filter(([_, qty]) => qty > 0)
        .map(([id, qty]) => {
          const product = products.find(p => p.id === id);
          return {
            productId: id,
            name: product.name,
            qty: qty,
            price: product.price
          };
        });
      
      const orderData = {
        customerId: customer.customerId,
        items: items,
        totalAmount: getCartTotal(),
        notes: document.getElementById('orderNotes').value.trim()
      };
      
      try {
        const res = await fetch(`${API_URL}?action=submitOrder&orderData=${encodeURIComponent(JSON.stringify(orderData))}`);
        const data = await res.json();
        
        if (data.success) {
          showSuccess(data.data.orderId);
        } else {
          alert('Failed to submit order: ' + (data.error || 'Unknown error'));
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Order';
        }
      } catch (error) {
        console.error('Submit error:', error);
        alert('Connection error. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Order';
      }
    }
    
    function showSuccess(orderId) {
      closeCheckoutModal();
      document.getElementById('cartSummary').classList.remove('visible');
      
      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>Place Your Order</h1>
          <p class="customer-name">Welcome, ${escapeHtml(customer.customerName)}</p>
        </div>
        <div class="success-screen">
          <div class="success-icon">✓</div>
          <h2>Order Submitted!</h2>
          <p>Your order <strong>${orderId}</strong> has been received.<br>We'll process it shortly.</p>
          <button class="new-order-btn" onclick="location.reload()">Place Another Order</button>
        </div>
      `;
    }
    
    // ====================
    // UTILS
    // ====================
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
    
    // ====================
    // START
    // ====================
    init();
  </script>
</body>
</html>

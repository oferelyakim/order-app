<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×–×× ×”</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; padding: 20px; direction: rtl; }
    .container { max-width: 600px; margin: 0 auto; }
    .header { text-align: center; padding: 20px; background: #fff; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header h1 { color: #333; font-size: 1.5rem; margin-bottom: 5px; }
    .header .customer-name { color: #666; font-size: 0.9rem; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; background: #fff; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .tab-btn:hover { border-color: #bdbdbd; }
    .tab-btn.active { border-color: #1976d2; background: #e3f2fd; color: #1976d2; }
    .error-screen, .loading-screen { text-align: center; padding: 60px 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .error-screen { color: #d32f2f; }
    .loading-screen { color: #666; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #1976d2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .panel { display: none; }
    .panel.active { display: block; }
    .products { display: grid; gap: 15px; }
    .product-card { background: #fff; border-radius: 12px; padding: 15px; display: flex; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .product-image { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; background: #e0e0e0; flex-shrink: 0; }
    .product-info { flex: 1; min-width: 0; }
    .product-name { font-weight: 600; color: #333; margin-bottom: 10px; }
    .qty-controls { display: flex; align-items: center; gap: 10px; }
    .qty-btn { width: 36px; height: 36px; border: none; border-radius: 8px; background: #e3f2fd; color: #1976d2; font-size: 1.2rem; cursor: pointer; }
    .qty-btn:hover { background: #bbdefb; }
    .qty-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .qty-value { min-width: 30px; text-align: center; font-weight: 600; font-size: 1.1rem; }
    .cart-summary { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; }
    .cart-summary.visible { display: block; }
    .cart-inner { max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 15px; }
    .cart-items-count { font-size: 0.85rem; color: #666; }
    .checkout-btn { background: #1976d2; color: #fff; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
    .modal-overlay.visible { display: flex; }
    .modal { background: #fff; border-radius: 16px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 1.2rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    .modal-body { padding: 20px; }
    .order-items { margin-bottom: 20px; }
    .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
    .notes-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical; min-height: 80px; margin-bottom: 20px; direction: rtl; }
    .submit-btn { width: 100%; background: #4caf50; color: #fff; border: none; padding: 16px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
    .submit-btn:disabled { background: #bdbdbd; }
    .success-screen { text-align: center; padding: 40px 20px; }
    .success-icon { width: 80px; height: 80px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2.5rem; }
    .success-screen h2 { color: #2e7d32; margin-bottom: 10px; }
    .new-order-btn { background: #1976d2; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; }
    .orders-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .status-filter-btn { padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 20px; background: #fff; font-size: 0.8rem; cursor: pointer; }
    .status-filter-btn.active { border-color: #1976d2; background: #e3f2fd; color: #1976d2; }
    .my-order-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .my-order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .my-order-id { font-weight: 600; color: #1976d2; }
    .my-order-date { color: #999; font-size: 0.85rem; }
    .status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .status.pending { background: #fff3e0; color: #e65100; }
    .status.processing { background: #e3f2fd; color: #1565c0; }
    .status.ready { background: #f3e5f5; color: #7b1fa2; }
    .status.delivered { background: #e8f5e9; color: #2e7d32; }
    .status.cancelled { background: #ffebee; color: #c62828; }
    .my-order-items { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
    .waybill-btn { background: #7b1fa2; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
    .empty-state { text-align: center; padding: 40px 20px; color: #999; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 15px; }
    .bottom-spacer { height: 100px; }
  </style>
</head>
<body>
  <div class="container" id="app"><div class="loading-screen"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div></div>
  <div class="cart-summary" id="cartSummary"><div class="cart-inner"><div class="cart-items-count" id="cartItemsCount">0 ×¤×¨×™×˜×™×</div><button class="checkout-btn" id="checkoutBtn">×¡×§×™×¨×ª ×”×–×× ×”</button></div></div>
  <div class="modal-overlay" id="checkoutModal"><div class="modal"><div class="modal-header"><h2>×¡×§×™×¨×ª ×”×–×× ×”</h2><button class="modal-close" id="closeModal">&times;</button></div><div class="modal-body" id="modalBody"></div></div></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz1twL3kPkXawFM-AqDqswcgEI2sd32HGylQeYgmpQAat-Hwu9LaZ1ukMHUirCpEm3o0A/exec';
    const COMPANY = { name: '××•×¨×™ × ×™×‘ ×§×¨×˜×•× ×™×', id: '___________', phone: '___________', address: '___________' };
    
    let customer = null, products = [], cart = {}, currentTab = 'order', myOrders = [], selectedStatuses = ['pending', 'processing', 'ready'];
    
    async function init() {
      const customerId = new URLSearchParams(window.location.search).get('c');
      if (!customerId) { showError('×§×™×©×•×¨ ×œ× ×ª×§×™×Ÿ', '×× × ×”×©×ª××© ×‘×§×™×©×•×¨ ×”×”×–×× ×” ×©× ×©×œ×— ××œ×™×š.'); return; }
      try {
        const customerRes = await fetch(`${API_URL}?action=getCustomer&customerId=${encodeURIComponent(customerId)}`);
        const customerData = await customerRes.json();
        if (!customerData.success || !customerData.data) { showError('×œ×§×•×— ×œ× ×ª×§×™×Ÿ', '×§×™×©×•×¨ ×”×”×–×× ×” ×©×œ×š ××™× ×• ×ª×§×£.'); return; }
        customer = customerData.data;
        const productsRes = await fetch(`${API_URL}?action=getProducts`);
        const productsData = await productsRes.json();
        if (!productsData.success) { showError('×©×’×™××”', '× ×›×©×œ ×‘×˜×¢×™× ×ª ×”××•×¦×¨×™×.'); return; }
        products = productsData.data;
        renderApp();
      } catch (error) { showError('×©×’×™××ª ×—×™×‘×•×¨', '×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨.'); }
    }
    
    function showError(title, message) { document.getElementById('app').innerHTML = `<div class="error-screen"><h2>${title}</h2><p>${message}</p></div>`; }
    
    function renderApp() {
      document.getElementById('app').innerHTML = `
        <div class="header"><h1>ğŸ“¦ ×”×–×× ×”</h1><p class="customer-name">×©×œ×•×, ${escapeHtml(customer.customerName)}</p></div>
        <div class="tabs"><button class="tab-btn active" data-tab="order" id="tabOrder">ğŸ›’ ×”×–×× ×” ×—×“×©×”</button><button class="tab-btn" data-tab="myorders" id="tabMyOrders">ğŸ“‹ ×”×”×–×× ×•×ª ×©×œ×™</button></div>
        <div class="panel active" id="orderPanel"><div class="products">${products.map(renderProduct).join('')}</div><div class="bottom-spacer"></div></div>
        <div class="panel" id="myOrdersPanel">
          <div class="orders-filters" id="ordersFilters"><button class="status-filter-btn active" data-status="pending">×××ª×™×Ÿ</button><button class="status-filter-btn active" data-status="processing">×‘×˜×™×¤×•×œ</button><button class="status-filter-btn active" data-status="ready">××•×›×Ÿ</button><button class="status-filter-btn" data-status="delivered">× ××¡×¨</button><button class="status-filter-btn" data-status="cancelled">×‘×•×˜×œ</button></div>
          <div id="myOrdersList"><div class="loading-screen"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div></div>
        </div>`;
      document.querySelectorAll('.qty-btn').forEach(btn => btn.addEventListener('click', handleQtyChange));
      document.getElementById('checkoutBtn').addEventListener('click', openCheckoutModal);
      document.getElementById('closeModal').addEventListener('click', closeCheckoutModal);
      document.getElementById('checkoutModal').addEventListener('click', e => { if (e.target.id === 'checkoutModal') closeCheckoutModal(); });
      document.getElementById('tabOrder').addEventListener('click', () => switchTab('order'));
      document.getElementById('tabMyOrders').addEventListener('click', () => switchTab('myorders'));
      document.querySelectorAll('#ordersFilters .status-filter-btn').forEach(btn => btn.addEventListener('click', () => toggleOrdersFilter(btn.dataset.status)));
      updateCartSummary();
    }
    
    function renderProduct(p) {
      const qty = cart[p.id] || 0;
      return `<div class="product-card"><img class="product-image" src="${escapeHtml(p.imageUrl || '')}" onerror="this.style.display='none'"><div class="product-info"><div class="product-name">${escapeHtml(p.name)}</div><div class="qty-controls"><button class="qty-btn" data-action="decrease" data-id="${p.id}" ${qty===0?'disabled':''}>âˆ’</button><span class="qty-value" id="qty-${p.id}">${qty}</span><button class="qty-btn" data-action="increase" data-id="${p.id}">+</button></div></div></div>`;
    }
    
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      if (tab === 'order') { document.getElementById('orderPanel').classList.add('active'); document.getElementById('cartSummary').style.display = ''; updateCartSummary(); }
      else { document.getElementById('myOrdersPanel').classList.add('active'); document.getElementById('cartSummary').style.display = 'none'; loadMyOrders(); }
    }
    
    async function loadMyOrders() {
      try {
        const res = await fetch(`${API_URL}?action=getCustomerOrders&customerId=${encodeURIComponent(customer.customerId)}`);
        const data = await res.json();
        if (data.success) { myOrders = data.data; renderMyOrders(); }
        else { document.getElementById('myOrdersList').innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>× ×›×©×œ ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª</p></div>'; }
      } catch (e) { document.getElementById('myOrdersList').innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>×©×’×™××ª ×—×™×‘×•×¨</p></div>'; }
    }
    
    function renderMyOrders() {
      let filtered = selectedStatuses.length > 0 ? myOrders.filter(o => selectedStatuses.includes(o.status)) : myOrders;
      if (filtered.length === 0) { document.getElementById('myOrdersList').innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><p>×œ× × ××¦××• ×”×–×× ×•×ª</p></div>'; return; }
      document.getElementById('myOrdersList').innerHTML = filtered.map(order => {
        const date = new Date(order.timestamp).toLocaleDateString('he-IL');
        const items = order.items.map(i => `${i.qty}x ${i.name}`).join(', ');
        const showWaybill = order.status === 'ready' || order.status === 'delivered';
        return `<div class="my-order-card"><div class="my-order-header"><div><div class="my-order-id">${order.orderId}</div><div class="my-order-date">${date}</div></div><span class="status ${order.status}">${formatStatus(order.status)}</span></div><div class="my-order-items">${escapeHtml(items)}</div>${showWaybill ? `<button class="waybill-btn" onclick="downloadWaybill('${order.orderId}')">ğŸ“„ ×ª×¢×•×“×ª ××©×œ×•×—</button>` : ''}</div>`;
      }).join('');
    }
    
    function formatStatus(s) { return {pending:'×××ª×™×Ÿ',processing:'×‘×˜×™×¤×•×œ',ready:'××•×›×Ÿ ×œ××©×œ×•×—',delivered:'× ××¡×¨',cancelled:'×‘×•×˜×œ'}[s]||s; }
    function toggleOrdersFilter(status) {
      const i = selectedStatuses.indexOf(status);
      if (i > -1) selectedStatuses.splice(i, 1); else selectedStatuses.push(status);
      document.querySelectorAll('#ordersFilters .status-filter-btn').forEach(btn => btn.classList.toggle('active', selectedStatuses.includes(btn.dataset.status)));
      renderMyOrders();
    }
    
    function downloadWaybill(orderId) {
      const order = myOrders.find(o => o.orderId === orderId);
      if (!order) return;
      const now = new Date();
      const day = String(now.getDate()).padStart(2,'0'), month = String(now.getMonth()+1).padStart(2,'0'), year = now.getFullYear();
      const docNum = order.orderId.replace('ORD','');
      let rowNum = 1;
      const itemsHtml = order.items.map(i => `<tr><td class="rn">${String(rowNum++).padStart(2,'0')}</td><td class="qty">${i.qty}</td><td class="desc">${escapeHtml(i.name)}</td></tr>`).join('');
      let emptyRows = ''; for (let i = rowNum; i <= 10; i++) emptyRows += `<tr><td class="rn">${String(i).padStart(2,'0')}</td><td class="qty"></td><td class="desc"></td></tr>`;
      
      const html = `<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>×ª×¢×•×“×ª ××©×œ×•×—</title>
<style>@page{size:A4;margin:10mm}*{box-sizing:border-box;margin:0;padding:0}body{font-family:Arial,sans-serif;direction:rtl;padding:15px;font-size:11px}
.hdr{display:flex;justify-content:space-between;margin-bottom:10px}.co{text-align:right}.co-name{font-size:20px;font-weight:bold}.co-det{font-size:10px;margin-top:5px;line-height:1.6}.logo{width:70px;height:70px;border:2px solid #000;display:flex;align-items:center;justify-content:center;font-weight:bold}
.title-row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}.doc-title{font-size:24px;font-weight:bold;border:2px solid #000;padding:5px 30px}.doc-num{border:2px solid #000;padding:5px 15px;font-size:16px;font-weight:bold}
.date-row{display:flex;justify-content:flex-end;margin-bottom:10px}.date-box{display:flex;border:1px solid #000}.date-box span{padding:5px 12px;border-left:1px solid #000;text-align:center}.date-box span:last-child{border:none}.date-lbl{background:#f0f0f0;font-weight:bold}
.info-row{display:flex;margin-bottom:8px}.info-lbl{font-weight:bold;min-width:80px}.info-val{flex:1;border-bottom:1px solid #000;padding:3px}
table{width:100%;border-collapse:collapse;margin-top:15px}th{background:#f0f0f0;border:1px solid #000;padding:8px;font-size:10px}td{border:1px solid #000;padding:5px;height:24px;text-align:center}td.desc{text-align:right;padding-right:10px}td.rn{width:35px;background:#fafafa}td.qty{width:50px}
.footer{margin-top:20px}.sig-row{display:flex;justify-content:space-between}.sig-box{width:45%}.sig-lbl{font-size:9px;margin-bottom:5px}.sig-line{border:1px solid #000;height:50px}</style></head>
<body>
<div class="hdr"><div class="co"><div class="co-name">${COMPANY.name}</div><div class="co-det">×¢×•×¡×§ ××•×¨×©×”: ${COMPANY.id}<br>×˜×œ×¤×•×Ÿ: ${COMPANY.phone}<br>×›×ª×•×‘×ª: ${COMPANY.address}</div></div><div class="logo">${COMPANY.name.split(' ')[0]}</div></div>
<div class="title-row"><div class="doc-title">×ª×¢×•×“×ª ××©×œ×•×—</div><div class="doc-num">${docNum}</div></div>
<div class="date-row"><div class="date-box"><span>${day}</span><span>${month}</span><span>${year}</span><span class="date-lbl">×ª××¨×™×š</span></div></div>
<div class="info-row"><span class="info-lbl">×©× ×”×œ×§×•×—:</span><span class="info-val">${escapeHtml(customer.customerName)}</span></div>
<div class="info-row"><span class="info-lbl">×›×ª×•×‘×ª:</span><span class="info-val">${escapeHtml(customer.contactInfo||'')}</span></div>
<table><thead><tr><th>××¡×³</th><th>×›××•×ª</th><th>×ª××•×¨ ×”×¡×—×•×¨×”</th></tr></thead><tbody>${itemsHtml}${emptyRows}</tbody></table>
<div class="footer"><div class="sig-row"><div class="sig-box"><div class="sig-lbl">×—×ª×™××ª ×”×œ×§×•×— - ×”× × ×™ ×××©×¨ ×§×‘×œ×ª ×”×¡×—×•×¨×”:</div><div class="sig-line"></div></div><div class="sig-box"><div class="sig-lbl">×—×ª×™××ª ×”××•×‘×™×œ:</div><div class="sig-line"></div></div></div></div>
</body></html>`;
      const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); setTimeout(() => w.print(), 500);
    }
    
    function handleQtyChange(e) {
      const btn = e.target, id = btn.dataset.id, action = btn.dataset.action;
      if (!cart[id]) cart[id] = 0;
      if (action === 'increase') cart[id]++; else if (action === 'decrease' && cart[id] > 0) cart[id]--;
      document.getElementById(`qty-${id}`).textContent = cart[id];
      document.querySelector(`.qty-btn[data-action="decrease"][data-id="${id}"]`).disabled = cart[id] === 0;
      updateCartSummary();
    }
    
    function updateCartSummary() {
      if (currentTab !== 'order') return;
      const total = Object.values(cart).reduce((s,q) => s+q, 0);
      document.getElementById('cartItemsCount').textContent = `${total} ×¤×¨×™×˜×™×`;
      document.getElementById('cartSummary').classList.toggle('visible', total > 0);
    }
    
    function openCheckoutModal() {
      const items = Object.entries(cart).filter(([_,q]) => q > 0).map(([id,qty]) => ({...products.find(p=>p.id===id), qty}));
      document.getElementById('modalBody').innerHTML = `<div class="order-items">${items.map(i => `<div class="order-item"><div>${escapeHtml(i.name)}</div><div>x${i.qty}</div></div>`).join('')}</div><textarea class="notes-input" id="orderNotes" placeholder="×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)"></textarea><button class="submit-btn" id="submitOrder">×©×œ×— ×”×–×× ×”</button>`;
      document.getElementById('submitOrder').addEventListener('click', submitOrder);
      document.getElementById('checkoutModal').classList.add('visible');
    }
    
    function closeCheckoutModal() { document.getElementById('checkoutModal').classList.remove('visible'); }
    
    async function submitOrder() {
      const btn = document.getElementById('submitOrder'); btn.disabled = true; btn.textContent = '×©×•×œ×—...';
      const items = Object.entries(cart).filter(([_,q])=>q>0).map(([id,qty])=>({productId:id,name:products.find(p=>p.id===id).name,qty}));
      try {
        const res = await fetch(`${API_URL}?action=submitOrder&orderData=${encodeURIComponent(JSON.stringify({customerId:customer.customerId,items,notes:document.getElementById('orderNotes').value.trim()}))}`);
        const data = await res.json();
        if (data.success) { closeCheckoutModal(); document.getElementById('cartSummary').classList.remove('visible'); document.getElementById('orderPanel').innerHTML = `<div class="success-screen"><div class="success-icon">âœ“</div><h2>×”×”×–×× ×” × ×©×œ×—×”!</h2><p>××¡×³ ×”×–×× ×”: <strong>${data.data.orderId}</strong></p><button class="new-order-btn" onclick="location.reload()">×”×–×× ×” ×—×“×©×”</button></div>`; }
        else { alert('×©×’×™××”: '+(data.error||'')); btn.disabled=false; btn.textContent='×©×œ×— ×”×–×× ×”'; }
      } catch(e) { alert('×©×’×™××ª ×—×™×‘×•×¨'); btn.disabled=false; btn.textContent='×©×œ×— ×”×–×× ×”'; }
    }
    
    function escapeHtml(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }
    init();
  </script>
</body>
</html>

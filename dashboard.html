<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×œ×•×— ×‘×§×¨×”</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;min-height:100vh;direction:rtl}
    .auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}.auth-box{background:#fff;padding:40px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);width:100%;max-width:360px;text-align:center}.auth-box h1{margin-bottom:10px}.auth-box p{color:#666;margin-bottom:25px}.auth-input{width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;margin-bottom:15px;text-align:center;letter-spacing:2px}.auth-input:focus{outline:none;border-color:#1976d2}.pin-wrapper{position:relative;margin-bottom:15px}.pin-wrapper input{margin-bottom:0}.toggle-pin{position:absolute;left:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.2rem}.auth-btn{width:100%;padding:14px;background:#1976d2;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer}.auth-error{color:#d32f2f;margin-top:15px;display:none}
    .app-container{display:none}.app-container.visible{display:block}.header{background:#1976d2;color:#fff;padding:15px 20px;position:sticky;top:0;z-index:50}.header-inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}.header h1{font-size:1.3rem}.logout-btn{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer}
    .tabs{background:#fff;border-bottom:1px solid #e0e0e0;position:sticky;top:54px;z-index:40}.tabs-inner{max-width:1200px;margin:0 auto;display:flex;overflow-x:auto}.tab{padding:15px 20px;border:none;background:none;font-size:0.95rem;color:#666;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap}.tab:hover{color:#333}.tab.active{color:#1976d2;border-bottom-color:#1976d2;font-weight:600}.tab .badge{background:#f44336;color:#fff;font-size:0.7rem;padding:2px 6px;border-radius:10px;margin-right:6px}.tab .badge.warning{background:#ff9800}
    .content{max-width:1200px;margin:0 auto;padding:20px}.panel{display:none}.panel.active{display:block}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:15px;overflow:hidden}.card-body{padding:15px 20px}
    .status{display:inline-block;padding:4px 10px;border-radius:20px;font-size:0.8rem;font-weight:500}.status.pending{background:#fff3e0;color:#e65100}.status.processing{background:#e3f2fd;color:#1565c0}.status.ready{background:#f3e5f5;color:#7b1fa2}.status.delivered{background:#e8f5e9;color:#2e7d32}.status.cancelled{background:#ffebee;color:#c62828}
    .order-card{cursor:pointer;transition:box-shadow 0.2s}.order-card:hover{box-shadow:0 4px 15px rgba(0,0,0,0.12)}.order-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}.order-id{font-weight:600;color:#1976d2}.order-customer{color:#333;font-weight:500;margin-bottom:5px}.order-date{color:#999;font-size:0.85rem}.order-items-preview{color:#666;font-size:0.9rem;margin:10px 0}
    .filters{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}.filter-select{padding:10px 15px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;min-width:150px}.status-filters{display:flex;gap:8px;flex-wrap:wrap}.status-filter-btn{padding:8px 14px;border:2px solid #e0e0e0;border-radius:20px;background:#fff;font-size:0.85rem;cursor:pointer}.status-filter-btn.active{border-color:#1976d2;background:#e3f2fd;color:#1976d2}.status-filter-btn.pending.active{border-color:#e65100;background:#fff3e0;color:#e65100}.status-filter-btn.processing.active{border-color:#1565c0;background:#e3f2fd;color:#1565c0}.status-filter-btn.ready.active{border-color:#7b1fa2;background:#f3e5f5;color:#7b1fa2}.status-filter-btn.delivered.active{border-color:#2e7d32;background:#e8f5e9;color:#2e7d32}.status-filter-btn.cancelled.active{border-color:#c62828;background:#ffebee;color:#c62828}
    table{width:100%;border-collapse:collapse}th,td{padding:12px 15px;text-align:right;border-bottom:1px solid #f0f0f0}th{background:#fafafa;font-weight:600;color:#666;font-size:0.85rem}.low-stock{background:#fff3e0!important}.low-stock-alert{background:#ff9800;color:#fff;padding:12px 20px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
    .btn{padding:8px 16px;border:none;border-radius:6px;font-size:0.9rem;cursor:pointer;font-weight:500}.btn-primary{background:#1976d2;color:#fff}.btn-danger{background:#f44336;color:#fff}.btn-secondary{background:#e0e0e0;color:#333}.btn-sm{padding:5px 10px;font-size:0.8rem}.action-btns{display:flex;gap:8px;flex-wrap:wrap}
    .add-btn{position:fixed;bottom:25px;left:25px;width:56px;height:56px;border-radius:50%;background:#1976d2;color:#fff;border:none;font-size:1.8rem;cursor:pointer;box-shadow:0 4px 15px rgba(25,118,210,0.4)}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}.modal-overlay.visible{display:flex}.modal{background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}.modal-header{padding:20px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}.modal-header h2{font-size:1.2rem}.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666}.modal-body{padding:20px}.modal-footer{padding:15px 20px;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-start;gap:10px}
    .form-group{margin-bottom:18px}.form-group label{display:block;margin-bottom:6px;font-weight:500;font-size:0.9rem}.form-control{width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:8px;font-size:1rem}.form-control:focus{outline:none;border-color:#1976d2}.form-check{display:flex;align-items:center;gap:8px}.form-check input{width:18px;height:18px}
    .order-detail-items{margin:15px 0}.order-detail-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0}.order-notes{background:#f5f5f5;padding:12px;border-radius:8px;margin:15px 0;font-style:italic;color:#666}.status-select{padding:10px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;width:100%;margin-top:10px}
    .customer-link{background:#e3f2fd;padding:12px;border-radius:8px;word-break:break-all;font-family:monospace;font-size:0.85rem;margin-top:10px;direction:ltr;text-align:left}.copy-btn{margin-top:10px}
    .empty-state{text-align:center;padding:60px 20px;color:#999}.loading{text-align:center;padding:40px;color:#666}.spinner{width:30px;height:30px;border:3px solid #e0e0e0;border-top-color:#1976d2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="auth-screen" id="authScreen">
    <div class="auth-box"><h1>ğŸ” ×œ×•×— ×‘×§×¨×”</h1><p>×”×›× ×¡ ×§×•×“ ×’×™×©×”</p><div class="pin-wrapper"><input type="password" class="auth-input" id="pinInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20"><button type="button" class="toggle-pin" id="togglePin">ğŸ‘ï¸</button></div><button class="auth-btn" id="loginBtn">×›× ×™×¡×”</button><p class="auth-error" id="authError"></p></div>
  </div>
  <div class="app-container" id="appContainer">
    <header class="header"><div class="header-inner"><h1>ğŸ“¦ ×œ×•×— ×‘×§×¨×”</h1><button class="logout-btn" id="logoutBtn">×™×¦×™××”</button></div></header>
    <nav class="tabs"><div class="tabs-inner"><button class="tab active" data-tab="orders">×”×–×× ×•×ª <span class="badge" id="pendingBadge" style="display:none">0</span></button><button class="tab" data-tab="products">××•×¦×¨×™×</button><button class="tab" data-tab="inventory">××œ××™ <span class="badge warning" id="lowStockBadge" style="display:none">0</span></button><button class="tab" data-tab="customers">×œ×§×•×—×•×ª</button></div></nav>
    <main class="content">
      <div class="panel active" id="ordersPanel"><div class="filters"><div class="status-filters" id="statusFilters"><button class="status-filter-btn pending active" data-status="pending">×××ª×™×Ÿ</button><button class="status-filter-btn processing active" data-status="processing">×‘×˜×™×¤×•×œ</button><button class="status-filter-btn ready active" data-status="ready">××•×›×Ÿ ×œ××©×œ×•×—</button><button class="status-filter-btn delivered" data-status="delivered">× ××¡×¨</button><button class="status-filter-btn cancelled" data-status="cancelled">×‘×•×˜×œ</button></div><select class="filter-select" id="customerFilter"><option value="">×›×œ ×”×œ×§×•×—×•×ª</option></select></div><div id="ordersList"></div></div>
      <div class="panel" id="productsPanel"><div class="card"><table><thead><tr><th>×©×</th><th>×¤×¢×™×œ</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="productsTable"></tbody></table></div></div>
      <div class="panel" id="inventoryPanel"><div id="lowStockAlert"></div><div class="card"><table><thead><tr><th>××•×¦×¨</th><th>×›××•×ª × ×•×›×—×™×ª</th><th>×¡×£</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="inventoryTable"></tbody></table></div></div>
      <div class="panel" id="customersPanel"><div class="card"><table><thead><tr><th>×©×</th><th>×›×ª×•×‘×ª / ×¤×¨×˜×™ ×§×©×¨</th><th>×”×¢×¨×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="customersTable"></tbody></table></div></div>
    </main>
    <button class="add-btn" id="addBtn">+</button>
  </div>
  <div class="modal-overlay" id="modal"><div class="modal"><div class="modal-header"><h2 id="modalTitle"></h2><button class="modal-close" id="modalClose">&times;</button></div><div class="modal-body" id="modalBody"></div><div class="modal-footer" id="modalFooter"></div></div></div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbz1twL3kPkXawFM-AqDqswcgEI2sd32HGylQeYgmpQAat-Hwu9LaZ1ukMHUirCpEm3o0A/exec';
const CLIENT_URL='https://oferelyakim.github.io/order-app/boxes_client.html';
const COMPANY={name:'×¢××™×¨ â€“ ×©×™×•×•×§ ×•×”×©×§×¢×•×ª ×‘×—×§×œ××•×ª ×‘×¢×´×',nameEn:'AMIR - Marketing and Investments in Agriculture Ltd',osekMurshe:'557678653',companyNum:'513615286',phone:'04-6322255',fax:'04-6120200',branch:'×¢×™×Ÿ ×™×”×‘ ×—×¦×‘×”',branchNum:'57'};

let token=localStorage.getItem('dashboardToken')||'',currentTab='orders',orders=[],products=[],inventory=[],customers=[],selectedStatuses=['pending','processing','ready'];

function checkAuth(){if(token){showApp();loadAllData();}}
function login(){const pin=document.getElementById('pinInput').value.trim();if(!pin){showAuthError('×× × ×”×›× ×¡ ×§×•×“');return;}token=pin;localStorage.setItem('dashboardToken',token);showApp();loadAllData();}
function logout(){token='';localStorage.removeItem('dashboardToken');document.getElementById('authScreen').style.display='flex';document.getElementById('appContainer').classList.remove('visible');document.getElementById('pinInput').value='';}
function showApp(){document.getElementById('authScreen').style.display='none';document.getElementById('appContainer').classList.add('visible');}
function showAuthError(msg){const el=document.getElementById('authError');el.textContent=msg;el.style.display='block';}

async function api(action,params={}){const url=new URL(API_URL);url.searchParams.set('action',action);url.searchParams.set('token',token);Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,typeof v==='object'?JSON.stringify(v):v));try{const res=await fetch(url);const data=await res.json();if(data.error==='Unauthorized'){showAuthError('×§×•×“ ×©×’×•×™');logout();return null;}return data;}catch(e){return{success:false,error:e.message};}}

async function loadAllData(){document.getElementById('ordersList').innerHTML='<div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ...</p></div>';const[o,p,i,c]=await Promise.all([api('getOrders'),api('getProducts'),api('getInventory'),api('getCustomers')]);if(o?.success)orders=o.data;if(p?.success)products=p.data;if(i?.success)inventory=i.data;if(c?.success)customers=c.data;renderAll();}

function renderAll(){renderOrders();renderProducts();renderInventory();renderCustomers();updateBadges();populateCustomerFilter();}
function updateBadges(){const pc=orders.filter(o=>o.status==='pending').length;const pb=document.getElementById('pendingBadge');pb.textContent=pc;pb.style.display=pc>0?'inline':'none';const lc=inventory.filter(i=>i.isLowStock).length;const lb=document.getElementById('lowStockBadge');lb.textContent=lc;lb.style.display=lc>0?'inline':'none';}
function populateCustomerFilter(){document.getElementById('customerFilter').innerHTML='<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>'+customers.map(c=>`<option value="${c.customerId}">${esc(c.customerName)}</option>`).join('');}
function formatStatus(s){return{pending:'×××ª×™×Ÿ',processing:'×‘×˜×™×¤×•×œ',ready:'××•×›×Ÿ ×œ××©×œ×•×—',delivered:'× ××¡×¨',cancelled:'×‘×•×˜×œ'}[s]||s;}

function renderOrders(){const cf=document.getElementById('customerFilter').value;let f=orders;if(selectedStatuses.length>0)f=f.filter(o=>selectedStatuses.includes(o.status));if(cf)f=f.filter(o=>o.customerId===cf);if(f.length===0){document.getElementById('ordersList').innerHTML='<div class="empty-state">ğŸ“‹<br>×œ× × ××¦××• ×”×–×× ×•×ª</div>';return;}document.getElementById('ordersList').innerHTML=f.map(o=>{const items=o.items.map(i=>`${i.qty}x ${i.name}`).join(', ');const date=new Date(o.timestamp).toLocaleString('he-IL');return`<div class="card order-card" onclick="showOrderDetail('${o.orderId}')"><div class="card-body"><div class="order-header"><div><div class="order-id">${o.orderId}</div><div class="order-customer">${esc(o.customerName)}</div><div class="order-date">${date}</div></div><span class="status ${o.status}">${formatStatus(o.status)}</span></div><div class="order-items-preview">${esc(items)}</div></div></div>`;}).join('');}

function toggleStatusFilter(status){const i=selectedStatuses.indexOf(status);if(i>-1)selectedStatuses.splice(i,1);else selectedStatuses.push(status);document.querySelectorAll('.status-filter-btn').forEach(b=>b.classList.toggle('active',selectedStatuses.includes(b.dataset.status)));renderOrders();}

function showOrderDetail(orderId){const order=orders.find(o=>o.orderId===orderId);if(!order)return;const date=new Date(order.timestamp).toLocaleString('he-IL');const showWaybill=order.status==='ready'||order.status==='delivered';openModal('×¤×¨×˜×™ ×”×–×× ×”',`<div><strong>××¡×³:</strong> ${order.orderId}<br><strong>×œ×§×•×—:</strong> ${esc(order.customerName)}<br><strong>×ª××¨×™×š:</strong> ${date}</div><div class="order-detail-items">${order.items.map(i=>`<div class="order-detail-item"><div><strong>${esc(i.name)}</strong><br><small>x${i.qty}</small></div></div>`).join('')}</div>${order.notes?`<div class="order-notes">"${esc(order.notes)}"</div>`:''}${showWaybill?`<button class="btn btn-secondary" onclick="downloadWaybill('${order.orderId}')" style="width:100%;margin-bottom:15px">ğŸ“„ ×ª×¢×•×“×ª ××©×œ×•×—</button>`:''}<div class="form-group"><label>×¡×˜×˜×•×¡</label><select class="status-select" id="orderStatusSelect" data-old-status="${order.status}"><option value="pending" ${order.status==='pending'?'selected':''}>×××ª×™×Ÿ</option><option value="processing" ${order.status==='processing'?'selected':''}>×‘×˜×™×¤×•×œ</option><option value="ready" ${order.status==='ready'?'selected':''}>××•×›×Ÿ ×œ××©×œ×•×—</option><option value="delivered" ${order.status==='delivered'?'selected':''}>× ××¡×¨</option><option value="cancelled" ${order.status==='cancelled'?'selected':''}>×‘×•×˜×œ</option></select></div>`,`<button class="btn btn-secondary" onclick="closeModal()">×¡×’×•×¨</button><button class="btn btn-primary" onclick="updateOrderStatus('${orderId}')">×©××•×¨</button>`);}

function downloadWaybill(orderId){const order=orders.find(o=>o.orderId===orderId);if(!order)return;const cust=customers.find(c=>c.customerId===order.customerId);const now=new Date();const day=String(now.getDate()).padStart(2,"0"),month=String(now.getMonth()+1).padStart(2,"0"),year=now.getFullYear();const docNum=order.orderId.replace("ORD","");let rn=1;const itemsHtml=order.items.map(i=>`<tr><td class="rn">${String(rn++).padStart(2,"0")}</td><td class="desc">${esc(i.name)}</td><td class="qty">${i.qty}</td></tr>`).join("");let empty="";for(let i=rn;i<=10;i++)empty+=`<tr><td class="rn">${String(i).padStart(2,"0")}</td><td class="desc"></td><td class="qty"></td></tr>`;const html=`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>×ª×¢×•×“×ª ××©×œ×•×—</title><style>@page{size:A4;margin:10mm}*{box-sizing:border-box;margin:0;padding:0}body{font-family:Arial,sans-serif;direction:rtl;padding:20px;font-size:11px;color:#000}.page-border{border:2px solid #000;padding:15px}.hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;border-bottom:1px solid #000;padding-bottom:8px}.co{text-align:right;flex:1}.co-name{font-size:22px;font-weight:bold;margin-bottom:2px}.co-name-en{font-size:11px;margin-bottom:4px;direction:ltr;text-align:right}.co-det{font-size:9px;line-height:1.5}.co-det span{margin-left:15px}.branch-box{text-align:center;border:2px solid #000;padding:8px 20px;font-size:14px;font-weight:bold;line-height:1.4;min-width:120px}.branch-label{font-size:9px;font-weight:normal}.title-section{display:flex;justify-content:space-between;align-items:center;margin:10px 0}.doc-title{font-size:28px;font-weight:bold}.doc-num-box{display:flex;align-items:center;border:2px solid #000}.doc-num-branch{padding:6px 12px;border-left:2px solid #000;font-size:14px;font-weight:bold;background:#f0f0f0}.doc-num-val{padding:6px 18px;font-size:16px;font-weight:bold;letter-spacing:1px}.meta-row{display:flex;justify-content:space-between;align-items:flex-start;margin:8px 0}.date-box{display:flex;border:1px solid #000}.date-box div{padding:4px 14px;border-left:1px solid #000;text-align:center;font-size:12px}.date-box div:last-child{border-left:none}.date-lbl{background:#f0f0f0;font-weight:bold;font-size:10px!important}.cust-num-box{border:1px solid #000;padding:4px 12px;font-size:11px}.cust-num-lbl{font-size:9px;color:#555}.info-section{margin:6px 0}.info-row{display:flex;align-items:center;margin-bottom:6px}.info-lbl{font-weight:bold;min-width:75px;font-size:10px}.info-val{flex:1;border-bottom:1px solid #000;padding:2px 5px;min-height:18px;font-size:11px}.info-row-pair{display:flex;gap:20px}.info-row-pair .info-row{flex:1}table{width:100%;border-collapse:collapse;margin-top:12px}th{background:#f0f0f0;border:1px solid #000;padding:6px 4px;font-size:9px;font-weight:bold;text-align:center}td{border:1px solid #000;padding:4px;height:22px;text-align:center;font-size:10px}td.desc{text-align:right;padding-right:8px}td.rn{width:30px;background:#fafafa;font-size:9px}td.qty{width:55px}.footer{margin-top:15px}.sig-row{display:flex;justify-content:space-between;margin-top:10px}.sig-box{width:45%}.sig-lbl{font-size:9px;margin-bottom:4px;font-weight:bold}.sig-line{border:1px solid #000;height:50px}.terms{margin-top:15px;padding-top:8px;border-top:1px solid #000;font-size:10px;font-weight:bold;text-align:center}.confirm-text{font-size:8px;text-align:center;margin-top:8px;line-height:1.4}</style></head><body><div class="page-border"><div class="hdr"><div class="co"><div class="co-name">${COMPANY.name}</div><div class="co-name-en">${COMPANY.nameEn}</div><div class="co-det">×¢×•×¡×§ ××•×¨×©×” <strong>${COMPANY.osekMurshe}</strong><span>×—×‘×¨×” ××¡×³ <strong>${COMPANY.companyNum}</strong></span><br>×˜×œ×¤×•×Ÿ: ${COMPANY.phone} &nbsp; ×¤×§×¡: ${COMPANY.fax}</div></div><div class="branch-box"><div class="branch-label">××—×¡×Ÿ / ×¡× ×™×£</div><div>${COMPANY.branchNum}</div><div style="font-size:12px;margin-top:4px">${COMPANY.branch}</div></div></div><div class="title-section"><div class="doc-title">×ª×¢×•×“×ª ××©×œ×•×—</div><div class="doc-num-box"><div class="doc-num-branch">×¡× ×™×£ ${COMPANY.branchNum}</div><div class="doc-num-val">${docNum}</div></div></div><div class="meta-row"><div class="cust-num-box"><div class="cust-num-lbl">××¡×¤×¨ ×œ×§×•×—</div><div>${esc(order.customerId||"")}</div></div><div class="date-box"><div>${day}</div><div>${month}</div><div>${year}</div><div class="date-lbl">×ª××¨×™×š</div></div></div><div class="info-section"><div class="info-row"><span class="info-lbl">×©× ×”×œ×§×•×—:</span><span class="info-val">${esc(order.customerName)}</span></div><div class="info-row"><span class="info-lbl">×›×ª×•×‘×ª:</span><span class="info-val">${cust?esc(cust.contactInfo||""):""}</span></div><div class="info-row-pair"><div class="info-row"><span class="info-lbl">××¡×³ ×¨×›×‘:</span><span class="info-val"></span></div><div class="info-row"><span class="info-lbl">×©× ×”××•×‘×™×œ:</span><span class="info-val"></span></div></div></div><table><thead><tr><th style="width:30px">××¡×³<br>×©×•×¨×”</th><th>×ª××•×¨ ×”×¡×—×•×¨×”</th><th style="width:55px">×›××•×ª<br>×©×œ××™×</th></tr></thead><tbody>${itemsHtml}${empty}</tbody></table><div class="footer"><div class="confirm-text">×”× × ×™ ×××©×¨×™× ××ª ×§×‘×œ×ª ×”×¡×—×•×¨×” ×”× ×´×œ ×‘×©×œ××•×ª×”<br>×•× × ×œ×—×™×™×‘ ××ª ×—×©×‘×•× × ×• ×‘×¡×›×•× ×“×œ×¢×™×œ.<br>×”××—×™×¨ ×”×¡×•×¤×™ ×™×§×‘×¢ ×‘×™×•× ××¡×™×¨×ª ×”×¡×—×•×¨×”.</div><div class="sig-row"><div class="sig-box"><div class="sig-lbl">×—×ª×™××ª ×”×œ×§×•×—:</div><div class="sig-line"></div></div><div class="sig-box"><div class="sig-lbl">×—×ª×™××ª ×”××—×¡× ××™:</div><div class="sig-line"></div></div></div><div class="terms">×ª× ××™ ×ª×©×œ×•×: ×—×•×“×© ×©×•×˜×£ + ______ ×™×•×</div></div></div></body></html>`;const w=window.open("","_blank");w.document.write(html);w.document.close();w.focus();setTimeout(()=>w.print(),500);}

async function updateOrderStatus(orderId){const sel=document.getElementById('orderStatusSelect');const newStatus=sel.value,oldStatus=sel.dataset.oldStatus;let doUpdate='false';if(newStatus==='ready'&&oldStatus!=='ready'&&oldStatus!=='delivered'){if(confirm('×œ×¢×“×›×Ÿ ××œ××™? ×”×›××•×™×•×ª ×™×§×•×–×–×• ××”××œ××™.'))doUpdate='true';}else if(oldStatus==='ready'&&(newStatus==='pending'||newStatus==='processing'||newStatus==='cancelled')){if(confirm('×œ×¢×“×›×Ÿ ××œ××™? ×”×›××•×™×•×ª ×™×•×—×–×¨×• ×œ××œ××™.'))doUpdate='true';}const res=await api('updateOrderStatus',{orderId,status:newStatus,updateInventory:doUpdate});if(res?.success){closeModal();await loadAllData();}else{alert('×©×’×™××”: '+(res?.error||''));}}

function renderProducts(){if(products.length===0){document.getElementById('productsTable').innerHTML='<tr><td colspan="3" style="text-align:center;padding:40px;color:#999">××™×Ÿ ××•×¦×¨×™×</td></tr>';return;}document.getElementById('productsTable').innerHTML=products.map(p=>`<tr><td><strong>${esc(p.name)}</strong></td><td>${p.active?'âœ…':'âŒ'}</td><td><div class="action-btns"><button class="btn btn-sm btn-secondary" onclick="editProduct('${p.id}')">×¢×¨×™×›×”</button><button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">××—×™×§×”</button></div></td></tr>`).join('');}

function showProductForm(product=null){const isEdit=!!product;openModal(isEdit?'×¢×¨×™×›×ª ××•×¦×¨':'×”×•×¡×¤×ª ××•×¦×¨',`<div class="form-group"><label>×©× *</label><input type="text" class="form-control" id="productName" value="${esc(product?.name||'')}"></div><div class="form-group"><label>×§×™×©×•×¨ ×ª××•× ×”</label><input type="text" class="form-control" id="productImage" value="${esc(product?.imageUrl||'')}"></div><div class="form-group"><label>×¡×£ ××œ××™ × ××•×š</label><input type="number" class="form-control" id="productThreshold" value="${product?.lowStockThreshold||10}"></div>${isEdit?'':`<div class="form-group"><label>×›××•×ª ×”×ª×—×œ×ª×™×ª</label><input type="number" class="form-control" id="productInitialQty" value="0"></div>`}<div class="form-group"><label class="form-check"><input type="checkbox" id="productActive" ${product?.active!==false?'checked':''}><span>×¤×¢×™×œ</span></label></div>`,`<button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button><button class="btn btn-primary" onclick="saveProduct(${isEdit?`'${product.id}'`:'null'})">${isEdit?'×¢×“×›×•×Ÿ':'×”×•×¡×¤×”'}</button>`);}

function editProduct(id){const p=products.find(x=>x.id===id);if(p)showProductForm(p);}

async function saveProduct(productId){const data={name:document.getElementById('productName').value.trim(),imageUrl:document.getElementById('productImage').value.trim(),lowStockThreshold:parseInt(document.getElementById('productThreshold').value)||10,active:document.getElementById('productActive').checked};if(!data.name){alert('×× × ×”×›× ×¡ ×©×');return;}let res;if(productId){data.id=productId;res=await api('updateProduct',{productData:data});}else{data.initialQty=parseInt(document.getElementById('productInitialQty').value)||0;res=await api('addProduct',{productData:data});}if(res?.success){closeModal();await loadAllData();}else{alert('×©×’×™××”: '+(res?.error||''));}}

async function deleteProduct(id){if(!confirm('×œ××—×•×§ ××•×¦×¨ ×–×”?'))return;const res=await api('deleteProduct',{productId:id});if(res?.success)await loadAllData();else alert('×©×’×™××”: '+(res?.error||''));}

function renderInventory(){const low=inventory.filter(i=>i.isLowStock);if(low.length>0){document.getElementById('lowStockAlert').innerHTML=`<div class="low-stock-alert"><span>âš ï¸</span><span><strong>${low.length} ××•×¦×¨×™×</strong> ××ª×—×ª ×œ×¡×£: ${low.map(i=>i.productName).join(', ')}</span></div>`;}else{document.getElementById('lowStockAlert').innerHTML='';}if(inventory.length===0){document.getElementById('inventoryTable').innerHTML='<tr><td colspan="4" style="text-align:center;padding:40px;color:#999">××™×Ÿ ××œ××™</td></tr>';return;}document.getElementById('inventoryTable').innerHTML=inventory.map(i=>`<tr class="${i.isLowStock?'low-stock':''}"><td>${esc(i.productName)}</td><td><strong>${i.currentQty}</strong></td><td>${i.lowStockThreshold||'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editInventory('${i.productId}',${i.currentQty})">×¢×“×›×•×Ÿ</button></td></tr>`).join('');}

function editInventory(productId,currentQty){openModal('×¢×“×›×•×Ÿ ××œ××™',`<div class="form-group"><label>×¡×•×’ ×¢×“×›×•×Ÿ</label><select class="form-control" id="inventoryMode" onchange="document.getElementById('inventoryQtyLabel').textContent=this.value==='add'?'×›××•×ª ×œ×”×•×¡×¤×”:':'×›××•×ª ×—×“×©×”:'"><option value="add" selected>×”×•×¡×¤×ª ××©×œ×•×—</option><option value="set">×¢×“×›×•×Ÿ ×›××•×ª × ×•×›×—×™×ª</option></select></div><div class="form-group"><label id="inventoryQtyLabel">×›××•×ª ×œ×”×•×¡×¤×”:</label><input type="number" class="form-control" id="inventoryQty" value="0" min="0"></div><p style="color:#666;font-size:0.9rem">×›××•×ª × ×•×›×—×™×ª: <strong>${currentQty}</strong></p>`,`<button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button><button class="btn btn-primary" onclick="saveInventory('${productId}',${currentQty})">×¢×“×›×•×Ÿ</button>`);}

async function saveInventory(productId,currentQty){const mode=document.getElementById('inventoryMode').value;const inputQty=parseInt(document.getElementById('inventoryQty').value)||0;const qty=mode==='add'?currentQty+inputQty:inputQty;const res=await api('updateInventory',{productId,qty:String(qty)});if(res?.success){closeModal();await loadAllData();}else{alert('×©×’×™××”: '+(res?.error||''));}}

function renderCustomers(){if(customers.length===0){document.getElementById('customersTable').innerHTML='<tr><td colspan="4" style="text-align:center;padding:40px;color:#999">××™×Ÿ ×œ×§×•×—×•×ª</td></tr>';return;}document.getElementById('customersTable').innerHTML=customers.map(c=>`<tr><td><strong>${esc(c.customerName)}</strong></td><td>${esc(c.contactInfo||'-')}</td><td>${esc(c.notes||'-')}</td><td><div class="action-btns"><button class="btn btn-sm btn-primary" onclick="showCustomerLink('${c.customerId}','${esc(c.customerName)}')">×§×™×©×•×¨</button><button class="btn btn-sm btn-secondary" onclick="editCustomer('${c.customerId}')">×¢×¨×™×›×”</button><button class="btn btn-sm btn-danger" onclick="deleteCustomer('${c.customerId}')">××—×™×§×”</button></div></td></tr>`).join('');}

function showCustomerLink(customerId,customerName){const link=`${CLIENT_URL}?c=${customerId}`;openModal('×§×™×©×•×¨ ×”×–×× ×” - '+customerName,`<p>×©×ª×£ ×§×™×©×•×¨ ×–×” ×¢× ×”×œ×§×•×—:</p><div class="customer-link" id="customerLinkText">${link}</div><button class="btn btn-secondary copy-btn" onclick="copyLink()">ğŸ“‹ ×”×¢×ª×§</button>`,`<button class="btn btn-primary" onclick="closeModal()">×¡×™×•×</button>`);}

function copyLink(){navigator.clipboard.writeText(document.getElementById('customerLinkText').textContent).then(()=>alert('×”×•×¢×ª×§!'));}

function showCustomerForm(customer=null){const isEdit=!!customer;openModal(isEdit?'×¢×¨×™×›×ª ×œ×§×•×—':'×”×•×¡×¤×ª ×œ×§×•×—',`<div class="form-group"><label>×©× *</label><input type="text" class="form-control" id="customerName" value="${esc(customer?.customerName||'')}"></div><div class="form-group"><label>×›×ª×•×‘×ª / ×¤×¨×˜×™ ×§×©×¨</label><input type="text" class="form-control" id="customerContact" value="${esc(customer?.contactInfo||'')}"></div><div class="form-group"><label>×”×¢×¨×•×ª</label><textarea class="form-control" id="customerNotes" rows="2">${esc(customer?.notes||'')}</textarea></div>`,`<button class="btn btn-secondary" onclick="closeModal()">×‘×™×˜×•×œ</button><button class="btn btn-primary" onclick="saveCustomer(${isEdit?`'${customer.customerId}'`:'null'})">${isEdit?'×¢×“×›×•×Ÿ':'×”×•×¡×¤×”'}</button>`);}

function editCustomer(id){const c=customers.find(x=>x.customerId===id);if(c)showCustomerForm(c);}

async function saveCustomer(customerId){const data={customerName:document.getElementById('customerName').value.trim(),contactInfo:document.getElementById('customerContact').value.trim(),notes:document.getElementById('customerNotes').value.trim()};if(!data.customerName){alert('×× × ×”×›× ×¡ ×©×');return;}let res;if(customerId){data.customerId=customerId;res=await api('updateCustomer',{customerData:data});}else{res=await api('addCustomer',{customerData:data});}if(res?.success){closeModal();await loadAllData();if(!customerId&&res.data?.customerId)setTimeout(()=>showCustomerLink(res.data.customerId,data.customerName),300);}else{alert('×©×’×™××”: '+(res?.error||''));}}

async function deleteCustomer(id){if(!confirm('×œ××—×•×§ ×œ×§×•×— ×–×”?'))return;const res=await api('deleteCustomer',{customerId:id});if(res?.success)await loadAllData();else alert('×©×’×™××”: '+(res?.error||''));}

function openModal(title,body,footer=''){document.getElementById('modalTitle').textContent=title;document.getElementById('modalBody').innerHTML=body;document.getElementById('modalFooter').innerHTML=footer;document.getElementById('modal').classList.add('visible');}
function closeModal(){document.getElementById('modal').classList.remove('visible');}

function switchTab(tab){currentTab=tab;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById(`${tab}Panel`).classList.add('active');}

function handleAdd(){if(currentTab==='products')showProductForm();else if(currentTab==='customers')showCustomerForm();}

function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):'';}

document.getElementById('loginBtn').addEventListener('click',login);
document.getElementById('pinInput').addEventListener('keypress',e=>{if(e.key==='Enter')login();});
document.getElementById('logoutBtn').addEventListener('click',logout);
document.getElementById('togglePin').addEventListener('click',()=>{const i=document.getElementById('pinInput'),b=document.getElementById('togglePin');if(i.type==='password'){i.type='text';b.textContent='ğŸ™ˆ';}else{i.type='password';b.textContent='ğŸ‘ï¸';}});
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
document.getElementById('addBtn').addEventListener('click',handleAdd);
document.getElementById('modalClose').addEventListener('click',closeModal);
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal();});
document.querySelectorAll('.status-filter-btn').forEach(b=>b.addEventListener('click',()=>toggleStatusFilter(b.dataset.status)));
document.getElementById('customerFilter').addEventListener('change',renderOrders);

checkAuth();
</script>
</body>
</html>
